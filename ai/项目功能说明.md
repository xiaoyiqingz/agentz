# AgentZ 项目功能说明

## 项目概述

AgentZ 是一个基于 Pydantic AI 框架构建的智能代理系统，提供交互式AI助手功能，支持代码生成、修改、文件操作等多种工具能力。

## 核心功能

### 1. 交互式AI对话系统

**入口文件**: `main.py`

- 提供交互式命令行界面
- 支持流式对话，实时显示AI响应
- 支持 Ctrl-C 优雅退出
- 基于异步事件循环实现

**主要特性**:
- 流式文本输出 (`stream_text`)
- 流式事件处理 (`event_stream_handler`)
- 消息历史管理
- 支持多轮对话

### 2. 代码操作工具集

#### 2.1 代码读取 (`tools/code_reader.py`)
- **功能**: 读取指定文件的指定行范围
- **工具函数**: `read_code_file(file_path, start_line, end_line)`
- **特性**:
  - 支持单行或行范围读取
  - 自动处理边界情况
  - 提供命令行接口

#### 2.2 代码生成 (`tools/coder.py`)
- **功能**: 根据文本描述生成Python代码
- **工具函数**: `generate_code(text)`
- **特性**:
  - 使用专门的代码生成Agent
  - 生成带详细注释的高质量代码
  - 遵循Python编程规范

#### 2.3 代码修改 (`tools/coder.py`)
- **功能**: 检查并修改现有代码
- **工具函数**: `check_and_modify_code(code_string, file_path, begin_line)`
- **特性**:
  - 自动检测代码错误
  - 提供改进建议
  - 返回修改后的代码（diff格式）

#### 2.4 代码补丁应用 (`tools/code_patcher.py`)
- **功能**: 将代码修改应用到文件
- **工具函数**: `apply_code_patch(file_path, patch_string)`
- **特性**:
  - 支持统一diff格式补丁
  - 自动创建备份文件（.orig）
  - 支持多hunk补丁应用

### 3. 内置命令系统 (`commands/builtin_commands.py`)

#### 3.1 直接处理型命令
执行后直接显示结果，等待用户继续输入：
- `exit` / `quit` / `q` - 退出程序
- `help` - 显示帮助信息
- `version` - 显示版本信息
- `clear` - 清屏

#### 3.2 转换型命令
将命令转换为用户输入传给AI处理：
- `time` - 查询当前时间
- `date` - 查询当前日期
- `weather` - 查询天气信息

### 4. 多模型支持

#### 4.1 Qwen模型 (`models/qwen.py`)
- **模型**: qwen3-coder-plus
- **用途**: 主要代码生成和修改
- **配置**: 通过环境变量 `QWEN_BASE_URL` 和 `QWEN_API_KEY` 配置

#### 4.2 DeepSeek模型 (`models/deepseek.py`)
- **模型**: deepseek-chat
- **配置**: 通过环境变量 `DEEPSEEK_API_KEY` 配置

#### 4.3 Ollama模型 (`models/ollama_qwen.py`)
- **支持**: 本地Ollama部署的模型
- **配置**: 通过环境变量 `OLLAMA_BASE_URL` 和 `OLLAMA_MODEL` 配置

### 5. MCP服务器集成 (`server.py`)

- **功能**: 集成MCP (Model Context Protocol) 服务器
- **实现**: 使用 `MCPServerSSE` 通过SSE连接MCP服务器
- **配置**: 通过环境变量 `MCP_SERVER_URL` 配置

### 6. 流式Thinking显示

**实现位置**: `server.py` 中的 `event_stream_handler`

- **功能**: 实时流式显示AI的思考过程
- **特性**:
  - 使用 `ThinkingPart` 和 `ThinkingPartDelta` 事件
  - 实时增量显示思考内容
  - 使用表情符号区分不同类型内容：
    - 🤔 Thinking - 思考过程
    - 🔧 调用tool - 工具调用
    - 📤 tool返回 - 工具返回结果

### 7. 系统提示词 (`prompts/prompt.py`)

#### 7.1 通用提示词 (`get_common_prompt`)
- 定义AI助手的角色和能力
- 说明可用工具及其用途
- 强调规划再行动的原则

#### 7.2 代码生成提示词 (`get_coder_prompt`)
- 专门用于代码生成和修改
- 要求遵循Python编程规范
- 要求以diff格式返回修改

### 8. 其他工具函数

#### 8.1 时间工具 (`server.py`)
- `get_current_time()` - 返回当前时间字符串

#### 8.2 天气工具 (`server.py`)
- `get_weather(city)` - 查询指定城市天气（通过wttr.in API）

### 9. 日志和监控

- **日志框架**: Logfire
- **配置**: 通过 `pyproject.toml` 配置
- **特性**:
  - 日志输出到文件而非控制台
  - 自动监控 Pydantic AI 和 HTTP 请求
  - 服务名称: mcp-server

## 技术架构

### 核心技术栈
- **框架**: Pydantic AI (>1.0.0)
- **异步**: asyncio
- **HTTP客户端**: httpx
- **环境变量**: python-dotenv
- **日志**: Logfire

### 依赖管理
- **包管理器**: uv
- **项目配置**: `pyproject.toml`
- **锁定文件**: `uv.lock`

**重要说明**: 本项目统一使用 `uv` 进行依赖管理和项目构建。所有第三方工具和依赖的安装、更新、管理都应通过 `uv` 完成。

### 项目结构
```
agentz/
├── main.py              # 主入口
├── server.py            # 服务器核心逻辑
├── anget.py             # Agent创建工具
├── input_handler.py     # 命令行输入处理器（readline封装）
├── pyproject.toml       # 项目配置和依赖定义
├── uv.lock              # uv 依赖锁定文件
├── commands/            # 内置命令
│   └── builtin_commands.py
├── models/              # 模型配置
│   ├── qwen.py
│   ├── deepseek.py
│   └── ollama_qwen.py
├── tools/               # 工具函数
│   ├── code_reader.py
│   ├── code_patcher.py
│   └── coder.py
├── prompts/             # 提示词
│   └── prompt.py
├── data/                # 数据目录（历史记录等）
│   └── agentz_history
├── tests/               # 测试
└── ai/                  # 项目文档
    ├── 项目功能说明.md
    └── 架构概览.md
```

## 开发环境设置

### 前置要求
- Python >= 3.13
- [uv](https://github.com/astral-sh/uv) 包管理器

### 安装和运行

1. **安装依赖**:
   ```bash
   uv sync
   ```

2. **运行程序**:
   ```bash
   uv run python main.py
   # 或者
   uv run main.py
   ```

3. **添加新依赖**:
   ```bash
   uv add <package-name>
   ```

4. **更新依赖**:
   ```bash
   uv sync --upgrade
   ```

5. **查看依赖**:
   ```bash
   uv tree
   ```

**注意**: 本项目统一使用 `uv` 管理依赖，请勿使用 `pip` 或其他包管理器安装依赖。

## 使用流程

1. **启动程序**: `uv run python main.py`
2. **输入命令或问题**: 支持自然语言或内置命令
3. **AI处理**: 
   - 显示思考过程（如果支持）
   - 调用必要工具
   - 返回结果
4. **流式显示**: 实时显示AI响应和工具调用过程
5. **继续对话**: 支持多轮对话，保持上下文

## 环境变量配置

```bash
# Qwen模型配置
QWEN_BASE_URL=<qwen_api_base_url>
QWEN_API_KEY=<qwen_api_key>

# DeepSeek模型配置
DEEPSEEK_API_KEY=<deepseek_api_key>

# Ollama配置（可选）
OLLAMA_BASE_URL=http://localhost:11434/v1
OLLAMA_MODEL=deepseek-r1:7b

# MCP服务器配置
MCP_SERVER_URL=<mcp_server_url>
```

## 主要特性总结

1. ✅ **流式对话**: 实时显示AI响应
2. ✅ **代码操作**: 读取、生成、修改、应用补丁
3. ✅ **多模型支持**: Qwen、DeepSeek、Ollama
4. ✅ **内置命令**: 快速执行常用操作
5. ✅ **MCP集成**: 扩展工具能力
6. ✅ **Thinking显示**: 可视化AI思考过程
7. ✅ **消息历史**: 支持多轮对话上下文
8. ✅ **错误处理**: 完善的异常处理机制

## 未来迭代方向建议

1. **功能扩展**:
   - 添加更多代码操作工具（如代码搜索、重构）
   - 支持更多文件格式（JSON、YAML等）
   - 添加Git操作集成

2. **用户体验**:
   - 添加配置文件支持
   - 改进命令提示和自动补全
   - 支持会话保存和恢复

3. **性能优化**:
   - 缓存机制
   - 并发工具调用
   - 流式响应优化

4. **监控和调试**:
   - 更详细的日志记录
   - 性能指标收集
   - 调试模式支持

