# AgentZ 架构概览

## 核心框架

### Pydantic AI
- **版本**: `pydantic-ai>1.0.0` (当前安装版本: 1.0.2)
- **官网**: https://ai.pydantic.dev/
- **文档**: 代码迭代需要使用新功能时，可以从源码中搜索或从官网地址中搜索
- **用途**: 本项目的主要 AI Agent 框架，用于构建和管理 Agent、流式处理、工具调用等

## 核心组件

### 1. 入口层
- **main.py**: 程序入口，启动交互式客户端

### 2. 服务层
- **server.py**: 
  - Agent实例创建和配置
  - 流式对话处理
  - 事件流处理（Thinking、工具调用等）
  - 消息历史管理

### 3. 工具层 (`tools/`)
- **code_reader.py**: 代码文件读取
- **code_patcher.py**: 代码补丁应用
- **coder.py**: 代码生成和修改（使用专门的代码Agent）

### 4. 模型层 (`models/`)
- **qwen.py**: Qwen模型配置（主要使用）
- **deepseek.py**: DeepSeek模型配置
- **ollama_qwen.py**: Ollama本地模型配置

### 5. 命令层 (`commands/`)
- **builtin_commands.py**: 内置命令处理（直接处理型、转换型）

### 6. 提示词层 (`prompts/`)
- **prompt.py**: 系统提示词定义（通用、代码生成）

### 7. 输入处理层
- **input_handler.py**: 命令行输入处理器，封装 readline 功能，提供增强的命令行输入体验

## 项目结构

```
agentz/
├── main.py              # 主入口
├── server.py            # 服务器核心逻辑
├── anget.py             # Agent创建工具
├── input_handler.py     # 命令行输入处理器（readline封装）
├── pyproject.toml       # 项目配置和依赖定义
├── uv.lock              # uv 依赖锁定文件
├── commands/            # 内置命令
│   └── builtin_commands.py
├── models/              # 模型配置
│   ├── qwen.py
│   ├── deepseek.py
│   └── ollama_qwen.py
├── tools/               # 工具函数
│   ├── code_reader.py
│   ├── code_patcher.py
│   └── coder.py
├── prompts/             # 提示词
│   └── prompt.py
├── data/                # 数据目录（历史记录等）
│   └── agentz_history
├── tests/               # 测试
└── ai/                  # 项目文档
    ├── 项目功能说明.md
    └── 架构概览.md
```

## 数据流

```
用户输入
  ↓
内置命令检查 (builtin_commands.py)
  ↓ (如果是内置命令)
命令处理 → 直接显示 或 转换为用户输入
  ↓
Agent处理 (server.py)
  ↓
事件流处理 (event_stream_handler)
  ├─ Thinking显示
  ├─ 工具调用
  └─ 结果返回
  ↓
流式文本输出
  ↓
消息历史更新
```

## Agent工具注册

### 内置工具
1. `get_current_time()` - 获取当前时间
2. `get_weather(city)` - 获取天气信息
3. `read_code_file(file_path, start_line, end_line)` - 读取代码文件
4. `apply_code_patch(file_path, patch_string)` - 应用代码补丁
5. `check_and_modify_code(code_string, file_path, begin_line)` - 检查并修改代码
6. `generate_code(text)` - 生成代码

### 外部工具集
- MCP Server工具集（通过MCPServerSSE集成）

## 关键设计模式

1. **依赖注入**: 使用 `Deps` 数据类注入HTTP客户端等依赖
2. **流式处理**: 异步迭代器处理事件流
3. **命令模式**: 内置命令使用命令模式处理
4. **工具模式**: Agent工具作为独立函数注册

## 配置管理

- **环境变量**: 通过 `.env` 文件管理
- **项目配置**: `pyproject.toml` 管理依赖和日志配置
- **模型配置**: 各模型文件独立配置
- **依赖管理**: 使用 `uv` 统一管理所有依赖和第三方工具

### 依赖管理工具：uv

本项目统一使用 [uv](https://github.com/astral-sh/uv) 进行依赖管理。

**常用命令**:
- `uv sync` - 安装/同步依赖
- `uv add <package>` - 添加新依赖
- `uv remove <package>` - 移除依赖
- `uv run <command>` - 在虚拟环境中运行命令
- `uv tree` - 查看依赖树

**重要**: 所有依赖的安装、更新、管理都应通过 `uv` 完成，不要使用 `pip` 或其他包管理器。

## 日志和监控

- **Logfire**: 统一日志和监控
- **自动监控**: Pydantic AI和HTTP请求自动监控
- **文件输出**: 日志输出到文件而非控制台

